# 04 - Security Implementation Analysis | å®‰å…¨å®ç°åˆ†æ

## Table of Contents | ç›®å½•

1. [è®¤è¯æœºåˆ¶ (Clerk)](#1-authentication-mechanism-clerk)
2. [é€Ÿç‡é™åˆ¶ (ArcJet)](#2-rate-limiting-arcjet)
3. [Bot æ£€æµ‹ (ArcJet)](#3-bot-detection-arcjet)
4. [è¾“å…¥éªŒè¯ (Zod)](#4-input-validation-zod)
5. [æ•°æ®ä¿æŠ¤](#5-data-protection)
6. [å®‰å…¨æ¶æ„æ¦‚è§ˆ](#6-security-architecture-overview)
7. [å®‰å…¨æœ€ä½³å®è·µ](#7-security-best-practices)

---

## 1. Authentication Mechanism (Clerk) | è®¤è¯æœºåˆ¶

### 1.1 Middleware Implementation | ä¸­é—´ä»¶å®ç°

**æ–‡ä»¶ä½ç½®**: `/home/user/ai-finance-platform/middleware.js:32-44`

#### æ ¸å¿ƒè®¤è¯é€»è¾‘

```javascript
const clerk = clerkMiddleware(async (auth, req) => {
  const { userId } = await auth();

  if (!userId && isProtectedRoute(req)) {
    const { redirectToSignIn } = await auth();
    return redirectToSignIn();
  }

  return NextResponse.next();
});
```

#### è®¤è¯æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Incoming HTTP Request                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ ArcJet          â”‚
                  â”‚ Middleware      â”‚
                  â”‚ (First Layer)   â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Clerk           â”‚
                  â”‚ Middleware      â”‚
                  â”‚ (Second Layer)  â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Extract userId  â”‚
                  â”‚ from Session    â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚                 â”‚
                  â–¼                 â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ userId Found â”‚   â”‚ No userId    â”‚
          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                  â”‚
                 â–¼                  â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Check Route  â”‚   â”‚ Check Route  â”‚
          â”‚ Protection   â”‚   â”‚ Protection   â”‚
          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
        â”‚              â”‚   â”‚              â”‚
        â–¼              â–¼   â–¼              â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚Protectedâ”‚  â”‚Public  â”‚ â”‚Protectedâ”‚ â”‚   Public     â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚           â”‚          â”‚              â”‚
        â–¼           â–¼          â–¼              â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚Continueâ”‚   â”‚Continueâ”‚ â”‚Redirect to  â”‚ â”‚Continueâ”‚
   â”‚        â”‚   â”‚        â”‚ â”‚ Sign In     â”‚ â”‚        â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 1.2 Protected Routes | ä¿æŠ¤è·¯ç”±åˆ—è¡¨

**æ–‡ä»¶ä½ç½®**: `/home/user/ai-finance-platform/middleware.js:5-9`

```javascript
const isProtectedRoute = createRouteMatcher([
  "/dashboard(.*)",
  "/account(.*)",
  "/transaction(.*)",
]);
```

#### è·¯ç”±ä¿æŠ¤è¯¦æƒ…

| è·¯ç”±æ¨¡å¼ | ä¿æŠ¤çº§åˆ« | è¯´æ˜ |
|---------|---------|------|
| `/dashboard(.*)` | ğŸ”’ å®Œå…¨ä¿æŠ¤ | ä»ªè¡¨æ¿åŠæ‰€æœ‰å­è·¯ç”± |
| `/account(.*)` | ğŸ”’ å®Œå…¨ä¿æŠ¤ | è´¦æˆ·è¯¦æƒ…é¡µåŠæ‰€æœ‰å­è·¯ç”± |
| `/transaction(.*)` | ğŸ”’ å®Œå…¨ä¿æŠ¤ | äº¤æ˜“åˆ›å»ºå’Œç®¡ç†é¡µé¢ |
| `/` | ğŸŒ å…¬å¼€è®¿é—® | é¦–é¡µ/ç™»å½•é¡µ |
| `/sign-in` | ğŸŒ å…¬å¼€è®¿é—® | ç™»å½•é¡µé¢ |
| `/sign-up` | ğŸŒ å…¬å¼€è®¿é—® | æ³¨å†Œé¡µé¢ |
| `/api/inngest` | ğŸ¤– Bot å…è®¸ | Inngest webhook |
| `/api/seed` | âš ï¸ éœ€ä¿æŠ¤ | å¼€å‘ç”¨é€”ï¼Œç”Ÿäº§ç¯å¢ƒåº”ç§»é™¤ |

#### Middleware é…ç½®èŒƒå›´

**æ–‡ä»¶ä½ç½®**: `/home/user/ai-finance-platform/middleware.js:46-53`

```javascript
export const config = {
  matcher: [
    // è·³è¿‡ Next.js å†…éƒ¨æ–‡ä»¶å’Œé™æ€èµ„æº
    "/((?!_next|[^?]*\\.(?:html?|css|js(?!on)|jpe?g|webp|png|gif|svg|ttf|woff2?|ico|csv|docx?|xlsx?|zip|webmanifest)).*)",
    // å§‹ç»ˆè¿è¡Œäº API è·¯ç”±
    "/(api|trpc)(.*)",
  ],
};
```

**åŒ¹é…è§„åˆ™**:
- âœ… æ‰€æœ‰é¡µé¢è·¯ç”±ï¼ˆé™¤é™æ€æ–‡ä»¶ï¼‰
- âœ… æ‰€æœ‰ API è·¯ç”±
- âŒ Next.js å†…éƒ¨æ–‡ä»¶ (`_next/*`)
- âŒ é™æ€èµ„æº (`.jpg`, `.css`, `.js` ç­‰)

---

### 1.3 User Auto-Creation Flow | ç”¨æˆ·è‡ªåŠ¨åˆ›å»ºæµç¨‹

**æ–‡ä»¶ä½ç½®**: `/home/user/ai-finance-platform/lib/checkUser.js:4-37`

#### å®Œæ•´ä»£ç 

```javascript
export const checkUser = async () => {
  const user = await currentUser();

  if (!user) {
    return null;
  }

  try {
    const loggedInUser = await db.user.findUnique({
      where: {
        clerkUserId: user.id,
      },
    });

    if (loggedInUser) {
      return loggedInUser;
    }

    const name = `${user.firstName} ${user.lastName}`;

    const newUser = await db.user.create({
      data: {
        clerkUserId: user.id,
        name,
        imageUrl: user.imageUrl,
        email: user.emailAddresses[0].emailAddress,
      },
    });

    return newUser;
  } catch (error) {
    console.log(error.message);
  }
};
```

#### æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    User Signs In (Clerk)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ currentUser()   â”‚
                  â”‚ from Clerk      â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚                 â”‚
                  â–¼                 â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ User Exists  â”‚   â”‚ No User      â”‚
          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                  â”‚
                 â–¼                  â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Query DB by  â”‚   â”‚ Return null  â”‚
          â”‚ clerkUserId  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚
        â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Found in DB  â”‚   â”‚ Not Found    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                  â”‚
       â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Return User  â”‚   â”‚ Create New User:     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ - clerkUserId        â”‚
                   â”‚ - name (first+last)  â”‚
                   â”‚ - email              â”‚
                   â”‚ - imageUrl           â”‚
                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ Return New   â”‚
                   â”‚ User         â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ•°æ®åŒæ­¥æ˜ å°„

| Clerk å­—æ®µ | æ•°æ®åº“å­—æ®µ | è¯´æ˜ |
|-----------|-----------|------|
| `user.id` | `clerkUserId` | Clerk ç”¨æˆ· ID (å”¯ä¸€æ ‡è¯†) |
| `user.firstName + user.lastName` | `name` | ç”¨æˆ·å…¨å |
| `user.emailAddresses[0].emailAddress` | `email` | ä¸»é‚®ç®±åœ°å€ |
| `user.imageUrl` | `imageUrl` | å¤´åƒ URL |

---

### 1.4 Server Actions Authentication | Server Actions è®¤è¯

**è®¤è¯æ¨¡å¼**: æ¯ä¸ª Server Action ç‹¬ç«‹éªŒè¯

#### æ ‡å‡†è®¤è¯ä»£ç 

```javascript
// ç¤ºä¾‹: actions/transaction.js:20-21
const { userId } = await auth();
if (!userId) throw new Error("Unauthorized");
```

#### å®Œæ•´è®¤è¯é“¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Client Calls Server Action                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ await auth()    â”‚
                  â”‚ (Clerk SDK)     â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚                 â”‚
                  â–¼                 â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ userId Found â”‚   â”‚ No userId    â”‚
          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                  â”‚
                 â–¼                  â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Query User   â”‚   â”‚ throw new Error  â”‚
          â”‚ from DB      â”‚   â”‚ "Unauthorized"   â”‚
          â”‚ by clerkId   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚
        â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Found   â”‚   â”‚ throw new Error  â”‚
â”‚              â”‚   â”‚ "User not found" â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Verify       â”‚
â”‚ Ownership    â”‚
â”‚ (if needed)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Execute      â”‚
â”‚ Business     â”‚
â”‚ Logic        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ‰€æœ‰ Server Actions è®¤è¯æ¸…å•

| Server Action | æ–‡ä»¶ | è¡Œå· | è®¤è¯æ£€æŸ¥ |
|--------------|------|------|---------|
| `getAccountWithTransactions` | account.js | 19-20 | âœ… |
| `bulkDeleteTransactions` | account.js | 53-54 | âœ… |
| `updateDefaultAccount` | account.js | 116-117 | âœ… |
| `createTransaction` | transaction.js | 20-21 | âœ… |
| `getTransaction` | transaction.js | 103-104 | âœ… |
| `updateTransaction` | transaction.js | 126-127 | âœ… |
| `getUserTransactions` | transaction.js | 200-201 | âœ… |
| `getCurrentBudget` | budget.js | 9-10 | âœ… |
| `updateBudget` | budget.js | 68-69 | âœ… |
| `getUserAccounts` | dashboard.js | 21-22 | âœ… |
| `createAccount` | dashboard.js | 56-57 | âœ… |
| `getDashboardData` | dashboard.js | 138-139 | âœ… |
| `sendEmail` | send-email.js | - | âŒ (å†…éƒ¨å‡½æ•°) |
| `seedTransactions` | seed.js | - | âŒ (å¼€å‘å·¥å…·) |

---

## 2. Rate Limiting (ArcJet) | é€Ÿç‡é™åˆ¶

### 2.1 Configuration | é…ç½®

**æ–‡ä»¶ä½ç½®**: `/home/user/ai-finance-platform/lib/arcjet.js:3-15`

```javascript
const aj = arcjet({
  key: process.env.ARCJET_KEY,
  characteristics: ["userId"],  // åŸºäºç”¨æˆ· ID é™æµ
  rules: [
    tokenBucket({
      mode: "LIVE",
      refillRate: 10,      // æ¯å°æ—¶è¡¥å…… 10 ä¸ªä»¤ç‰Œ
      interval: 3600,      // 1 å°æ—¶ = 3600 ç§’
      capacity: 10,        // æ¡¶å®¹é‡ 10 ä¸ªä»¤ç‰Œ
    }),
  ],
});
```

#### Token Bucket ç®—æ³•è¯´æ˜

**å·¥ä½œåŸç†**:
```
Time: 0:00           0:30           1:00           1:30
      â”‚              â”‚              â”‚              â”‚
      â–¼              â–¼              â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tokens:  â”‚   â”‚ Tokens:  â”‚   â”‚ Tokens:  â”‚   â”‚ Tokens:  â”‚
â”‚ 10/10    â”‚ â†’ â”‚  5/10    â”‚ â†’ â”‚ 10/10    â”‚ â†’ â”‚  7/10    â”‚
â”‚          â”‚   â”‚          â”‚   â”‚(refilled)â”‚   â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  User makes      User makes     Bucket          User makes
  5 requests      0 requests     refills         3 requests
```

**å‚æ•°è¯¦è§£**:
- **refillRate**: æ¯ä¸ªæ—¶é—´é—´éš”è¡¥å……çš„ä»¤ç‰Œæ•°
- **interval**: è¡¥å……é—´éš”ï¼ˆç§’ï¼‰
- **capacity**: æ¡¶çš„æœ€å¤§å®¹é‡
- **requested**: æ¯æ¬¡è¯·æ±‚æ¶ˆè€—çš„ä»¤ç‰Œæ•°

**é™åˆ¶æ•ˆæœ**:
- ç”¨æˆ·æ¯å°æ—¶æœ€å¤š 10 æ¬¡è¯·æ±‚
- çªå‘æµé‡æœ€å¤š 10 æ¬¡ï¼ˆå¦‚æœæ¡¶æ»¡ï¼‰
- è¶…è¿‡é™åˆ¶åéœ€è¦ç­‰å¾… 1 å°æ—¶é‡ç½®

---

### 2.2 Application in Server Actions | åœ¨ Server Actions ä¸­çš„åº”ç”¨

#### åº”ç”¨ä½ç½®

1. **createTransaction** (`actions/transaction.js:24-47`)
2. **createAccount** (`actions/dashboard.js:60-83`)

#### æ ‡å‡†å®ç°æ¨¡å¼

```javascript
// Step 1: è·å–è¯·æ±‚å¯¹è±¡
const req = await request();

// Step 2: æ‰§è¡Œé€Ÿç‡é™åˆ¶æ£€æŸ¥
const decision = await aj.protect(req, {
  userId,
  requested: 1,  // æ¶ˆè€— 1 ä¸ªä»¤ç‰Œ
});

// Step 3: å¤„ç†æ‹’ç»æƒ…å†µ
if (decision.isDenied()) {
  if (decision.reason.isRateLimit()) {
    const { remaining, reset } = decision.reason;
    console.error({
      code: "RATE_LIMIT_EXCEEDED",
      details: {
        remaining,           // å‰©ä½™ä»¤ç‰Œæ•°
        resetInSeconds: reset,  // é‡ç½®å€’è®¡æ—¶ï¼ˆç§’ï¼‰
      },
    });

    throw new Error("Too many requests. Please try again later.");
  }

  throw new Error("Request blocked");
}
```

---

### 2.3 Error Handling | é”™è¯¯å¤„ç†

#### é€Ÿç‡é™åˆ¶é”™è¯¯å“åº”

**æœåŠ¡ç«¯æ—¥å¿—**:
```javascript
{
  code: "RATE_LIMIT_EXCEEDED",
  details: {
    remaining: 0,          // å‰©ä½™ 0 ä¸ªä»¤ç‰Œ
    resetInSeconds: 3245,  // 3245 ç§’åé‡ç½®ï¼ˆçº¦ 54 åˆ†é’Ÿï¼‰
  }
}
```

**å®¢æˆ·ç«¯é”™è¯¯ä¿¡æ¯**:
```
"Too many requests. Please try again later."
```

#### é”™è¯¯å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Server Action Called                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Authentication  â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ await request() â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ aj.protect()    â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚                 â”‚
                  â–¼                 â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ isAllowed()  â”‚   â”‚ isDenied()   â”‚
          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                  â”‚
                 â–¼                  â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Continue     â”‚   â”‚ Check Reason:    â”‚
          â”‚ Business     â”‚   â”‚ - isRateLimit()  â”‚
          â”‚ Logic        â”‚   â”‚ - Other          â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚                 â”‚
                           â–¼                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Rate Limit   â”‚  â”‚ Other Block  â”‚
                    â”‚ Error        â”‚  â”‚ Reason       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚                 â”‚
                           â–¼                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Log Details: â”‚  â”‚ throw        â”‚
                    â”‚ - remaining  â”‚  â”‚ "Request     â”‚
                    â”‚ - reset      â”‚  â”‚  blocked"    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ throw        â”‚
                    â”‚ "Too many    â”‚
                    â”‚  requests"   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2.4 Rate Limit Configuration Comparison | é…ç½®å¯¹æ¯”

| é…ç½®ç±»å‹ | ä½ç½® | é™åˆ¶èŒƒå›´ | é™åˆ¶å€¼ | ç‰¹æ€§ |
|---------|------|---------|-------|------|
| **Server Actions** | lib/arcjet.js | æ¯ç”¨æˆ· | 10 req/hour | Token Bucket |
| **Middleware** | middleware.js | å…¨å±€ | æ— é€Ÿç‡é™åˆ¶ | Shield + Bot Detection |

**ä¸ºä»€ä¹ˆåˆ†å¼€é…ç½®ï¼Ÿ**
1. **Middleware**: å…¨å±€å®‰å…¨é˜²æŠ¤ï¼ˆXSS, SQLæ³¨å…¥, Botï¼‰
2. **Server Actions**: ç‰¹å®šæ“ä½œé€Ÿç‡é™åˆ¶ï¼ˆåˆ›å»ºè´¦æˆ·ã€äº¤æ˜“ï¼‰

---

## 3. Bot Detection (ArcJet) | Bot æ£€æµ‹

### 3.1 Configuration | é…ç½®

**æ–‡ä»¶ä½ç½®**: `/home/user/ai-finance-platform/middleware.js:20-27`

```javascript
detectBot({
  mode: "LIVE",  // å®æ—¶é˜»æ­¢ï¼Œä½¿ç”¨ "DRY_RUN" ä»…è®°å½•æ—¥å¿—
  allow: [
    "CATEGORY:SEARCH_ENGINE", // Google, Bing, DuckDuckGo ç­‰
    "GO_HTTP",                // Inngest webhook ä½¿ç”¨ Go HTTP å®¢æˆ·ç«¯
    // å®Œæ•´åˆ—è¡¨: https://arcjet.com/bot-list
  ],
})
```

---

### 3.2 Shield Protection | Shield é˜²æŠ¤é…ç½®

**æ–‡ä»¶ä½ç½®**: `/home/user/ai-finance-platform/middleware.js:17-19`

```javascript
shield({
  mode: "LIVE",  // å®æ—¶é˜²æŠ¤
})
```

**Shield é˜²æŠ¤å†…å®¹**:
- âœ… SQL æ³¨å…¥æ£€æµ‹
- âœ… XSS (è·¨ç«™è„šæœ¬) é˜²æŠ¤
- âœ… è·¯å¾„éå†æ”»å‡»
- âœ… æ¶æ„ payload æ£€æµ‹
- âœ… å†…å®¹å®‰å…¨ç­–ç•¥

---

### 3.3 Allowed Bots List | å…è®¸çš„ Bot åˆ—è¡¨

#### æœç´¢å¼•æ“çˆ¬è™«

**ç±»åˆ«**: `CATEGORY:SEARCH_ENGINE`

**åŒ…å«çš„çˆ¬è™«**:
- Googlebot (Google æœç´¢)
- Bingbot (Bing æœç´¢)
- DuckDuckBot (DuckDuckGo)
- Baiduspider (ç™¾åº¦)
- Yandex Bot (Yandex)
- Yahoo Slurp (Yahoo)

**ä¸ºä»€ä¹ˆå…è®¸ï¼Ÿ**
- SEO ä¼˜åŒ–éœ€è¦
- æé«˜ç½‘ç«™å¯å‘ç°æ€§
- å¢åŠ è‡ªç„¶æµé‡

---

#### Inngest Webhook

**æ ‡è¯†**: `GO_HTTP`

**ä¸ºä»€ä¹ˆå…è®¸ï¼Ÿ**
```javascript
// Inngest ä½¿ç”¨ Go ç¼–å†™çš„ HTTP å®¢æˆ·ç«¯
// User-Agent: Go-http-client/1.1

// åå°ä½œä¸šéœ€è¦è°ƒç”¨ /api/inngest ç«¯ç‚¹:
// - processRecurringTransaction
// - triggerRecurringTransactions
// - generateMonthlyReports
// - checkBudgetAlerts
```

**å®‰å…¨æ€§è€ƒè™‘**:
- Inngest æœ‰è‡ªå·±çš„ç­¾åéªŒè¯æœºåˆ¶
- ä»…å…è®¸ç‰¹å®š User-Agent
- ç«¯ç‚¹ä»…æ¥å—æ¥è‡ª Inngest çš„è¯·æ±‚

---

### 3.4 Bot Detection Flow | Bot æ£€æµ‹æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Incoming HTTP Request                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Extract         â”‚
                  â”‚ User-Agent      â”‚
                  â”‚ Header          â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ ArcJet Bot      â”‚
                  â”‚ Detection       â”‚
                  â”‚ Analysis        â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚            â”‚            â”‚
              â–¼            â–¼            â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Known    â”‚  â”‚ Allowed  â”‚  â”‚ Unknown/ â”‚
      â”‚ Good Bot â”‚  â”‚ Bot      â”‚  â”‚ Bad Bot  â”‚
      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
           â”‚             â”‚              â”‚
           â–¼             â–¼              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Is in    â”‚  â”‚ Check    â”‚  â”‚ mode: LIVE?  â”‚
    â”‚ Allow    â”‚  â”‚ Category â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ List?    â”‚  â”‚          â”‚         â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
         â”‚             â”‚          â”‚         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”   â–¼         â–¼
    â”‚          â”‚  â”‚          â”‚  LIVE    DRY_RUN
    â–¼ YES      â–¼ NO  â–¼ YES    â–¼ NO â”‚         â”‚
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ Allow  â”‚ â”‚ Block  â”‚ â”‚ Allow  â”‚ â”‚ Block  â”‚ â”‚ Log &  â”‚
 â”‚        â”‚ â”‚        â”‚ â”‚        â”‚ â”‚        â”‚ â”‚ Allow  â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Input Validation (Zod) | è¾“å…¥éªŒè¯

### 4.1 Schema Definitions | Schema å®šä¹‰

**æ–‡ä»¶ä½ç½®**: `/home/user/ai-finance-platform/app/lib/schema.js`

#### Account Schema | è´¦æˆ·éªŒè¯ Schema

```javascript
export const accountSchema = z.object({
  name: z.string().min(1, "Name is required"),
  type: z.enum(["CURRENT", "SAVINGS"]),
  balance: z.string().min(1, "Initial balance is required"),
  isDefault: z.boolean().default(false),
});
```

**å­—æ®µéªŒè¯**:
| å­—æ®µ | ç±»å‹ | éªŒè¯è§„åˆ™ | é”™è¯¯ä¿¡æ¯ |
|------|------|---------|---------|
| `name` | string | éç©º | "Name is required" |
| `type` | enum | CURRENT æˆ– SAVINGS | Zod é»˜è®¤é”™è¯¯ |
| `balance` | string | éç©º | "Initial balance is required" |
| `isDefault` | boolean | å¯é€‰ï¼Œé»˜è®¤ false | - |

---

#### Transaction Schema | äº¤æ˜“éªŒè¯ Schema

```javascript
export const transactionSchema = z
  .object({
    type: z.enum(["INCOME", "EXPENSE"]),
    amount: z.string().min(1, "Amount is required"),
    description: z.string().optional(),
    date: z.date({ required_error: "Date is required" }),
    accountId: z.string().min(1, "Account is required"),
    category: z.string().min(1, "Category is required"),
    isRecurring: z.boolean().default(false),
    recurringInterval: z
      .enum(["DAILY", "WEEKLY", "MONTHLY", "YEARLY"])
      .optional(),
  })
  .superRefine((data, ctx) => {
    if (data.isRecurring && !data.recurringInterval) {
      ctx.addIssue({
        code: z.ZodIssueCode.custom,
        message: "Recurring interval is required for recurring transactions",
        path: ["recurringInterval"],
      });
    }
  });
```

**å­—æ®µéªŒè¯**:
| å­—æ®µ | ç±»å‹ | éªŒè¯è§„åˆ™ | é”™è¯¯ä¿¡æ¯ |
|------|------|---------|---------|
| `type` | enum | INCOME æˆ– EXPENSE | Zod é»˜è®¤é”™è¯¯ |
| `amount` | string | éç©º | "Amount is required" |
| `description` | string | å¯é€‰ | - |
| `date` | Date | å¿…éœ€ | "Date is required" |
| `accountId` | string | éç©º | "Account is required" |
| `category` | string | éç©º | "Category is required" |
| `isRecurring` | boolean | å¯é€‰ï¼Œé»˜è®¤ false | - |
| `recurringInterval` | enum | å¯é€‰ï¼ŒDAILY/WEEKLY/MONTHLY/YEARLY | - |

**é«˜çº§éªŒè¯ (superRefine)**:
- å¦‚æœ `isRecurring` ä¸º trueï¼Œåˆ™ `recurringInterval` å¿…å¡«
- è‡ªå®šä¹‰é”™è¯¯ä¿¡æ¯å’Œè·¯å¾„

---

### 4.2 Frontend Validation | å‰ç«¯éªŒè¯

**å®ç°æ–¹å¼**: React Hook Form + Zod Resolver

#### ç¤ºä¾‹ä»£ç ï¼ˆæ¨æµ‹ï¼‰

```javascript
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { transactionSchema } from "@/app/lib/schema";

function TransactionForm() {
  const form = useForm({
    resolver: zodResolver(transactionSchema),
    defaultValues: {
      type: "EXPENSE",
      amount: "",
      description: "",
      date: new Date(),
      accountId: "",
      category: "",
      isRecurring: false,
    },
  });

  const onSubmit = async (data) => {
    // data å·²ç»é€šè¿‡ Zod éªŒè¯
    const result = await createTransaction({
      ...data,
      amount: parseFloat(data.amount),
    });
  };

  return (
    <form onSubmit={form.handleSubmit(onSubmit)}>
      {/* Form fields */}
    </form>
  );
}
```

**éªŒè¯æ—¶æœº**:
- âœ… **onChange**: å­—æ®µå€¼æ”¹å˜æ—¶
- âœ… **onBlur**: å¤±å»ç„¦ç‚¹æ—¶
- âœ… **onSubmit**: æäº¤è¡¨å•æ—¶

---

### 4.3 Backend Validation | åç«¯éªŒè¯

**é—®é¢˜**: Server Actions ä¸­æ²¡æœ‰æ˜¾å¼çš„ Zod éªŒè¯

**å½“å‰å®ç°**:
```javascript
// actions/dashboard.js:94-97
const balanceFloat = parseFloat(data.balance);
if (isNaN(balanceFloat)) {
  throw new Error("Invalid balance amount");
}
```

**å»ºè®®æ”¹è¿›**:
```javascript
// åœ¨ Server Action ä¸­æ·»åŠ éªŒè¯
export async function createAccount(data) {
  try {
    // 1. éªŒè¯è¾“å…¥æ•°æ®
    const validatedData = accountSchema.parse(data);

    // 2. è®¤è¯å’Œæˆæƒ
    const { userId } = await auth();
    if (!userId) throw new Error("Unauthorized");

    // 3. ä¸šåŠ¡é€»è¾‘
    // ...
  } catch (error) {
    if (error instanceof z.ZodError) {
      return { success: false, error: error.errors };
    }
    throw error;
  }
}
```

---

### 4.4 Validation Flow | éªŒè¯æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    User Fills Form                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ onChange/       â”‚
                  â”‚ onBlur Events   â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ React Hook Form â”‚
                  â”‚ + Zod Resolver  â”‚
                  â”‚ Validation      â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚                 â”‚
                  â–¼                 â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Valid        â”‚   â”‚ Invalid      â”‚
          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                  â”‚
                 â–¼                  â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Clear Error  â”‚   â”‚ Show Error   â”‚
          â”‚ Message      â”‚   â”‚ Message      â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    User Submits Form                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Final Form      â”‚
                  â”‚ Validation      â”‚
                  â”‚ (All Fields)    â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚                 â”‚
                  â–¼                 â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ All Valid    â”‚   â”‚ Has Errors   â”‚
          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                  â”‚
                 â–¼                  â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Call Server  â”‚   â”‚ Prevent      â”‚
          â”‚ Action       â”‚   â”‚ Submission   â”‚
          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ Show Errors  â”‚
                 â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Server-side  â”‚
          â”‚ Processing   â”‚
          â”‚ (Should add  â”‚
          â”‚  validation) â”‚
          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Business     â”‚
          â”‚ Logic        â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Data Protection | æ•°æ®ä¿æŠ¤

### 5.1 Environment Variables Management | ç¯å¢ƒå˜é‡ç®¡ç†

#### æ•æ„Ÿé…ç½®æ¸…å•

| å˜é‡å | ç”¨é€” | ä½ç½® |
|-------|------|------|
| `DATABASE_URL` | Prisma æ•°æ®åº“è¿æ¥ | Prisma Client |
| `DIRECT_URL` | Prisma ç›´è¿ URL | Prisma Migrations |
| `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY` | Clerk å…¬é’¥ | å®¢æˆ·ç«¯ |
| `CLERK_SECRET_KEY` | Clerk å¯†é’¥ | æœåŠ¡ç«¯ |
| `ARCJET_KEY` | ArcJet API å¯†é’¥ | ä¸­é—´ä»¶ + Server Actions |
| `GEMINI_API_KEY` | Google Gemini API å¯†é’¥ | Server Actions |
| `RESEND_API_KEY` | Resend é‚®ä»¶ API å¯†é’¥ | Server Actions |
| `INNGEST_EVENT_KEY` | Inngest äº‹ä»¶å¯†é’¥ | Inngest å®¢æˆ·ç«¯ |
| `INNGEST_SIGNING_KEY` | Inngest ç­¾åå¯†é’¥ | Webhook éªŒè¯ |

#### å®‰å…¨æªæ–½

**1. .gitignore é…ç½®**:
```gitignore
# Environment variables
.env
.env.local
.env.production.local
.env.development.local
```

**2. ç¯å¢ƒå˜é‡è®¿é—®æ§åˆ¶**:
```javascript
// âœ… æœåŠ¡ç«¯å®‰å…¨è®¿é—®
process.env.GEMINI_API_KEY

// âŒ æ°¸è¿œä¸è¦åœ¨å®¢æˆ·ç«¯ä½¿ç”¨æœåŠ¡ç«¯å¯†é’¥
// åªæœ‰ NEXT_PUBLIC_* å‰ç¼€çš„å˜é‡å¯ä»¥åœ¨å®¢æˆ·ç«¯è®¿é—®
```

**3. å¯†é’¥è½®æ¢ç­–ç•¥**:
- å®šæœŸæ›´æ¢ API å¯†é’¥
- ä½¿ç”¨å¯†é’¥ç®¡ç†æœåŠ¡ (å¦‚ AWS Secrets Manager)
- ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ä¸åŒçš„å¯†é’¥

---

### 5.2 SQL Injection Protection (Prisma) | SQL æ³¨å…¥é˜²æŠ¤

**Prisma ORM è‡ªåŠ¨é˜²æŠ¤**:

#### å®‰å…¨ç¤ºä¾‹

```javascript
// âœ… Prisma è‡ªåŠ¨å‚æ•°åŒ–æŸ¥è¯¢
const user = await db.user.findUnique({
  where: { clerkUserId: userId },  // è‡ªåŠ¨è½¬ä¹‰
});

// âœ… ä½¿ç”¨ Prisma çš„ç±»å‹å®‰å…¨æŸ¥è¯¢
const transactions = await db.transaction.findMany({
  where: {
    userId: user.id,
    type: data.type,  // Enum ç±»å‹éªŒè¯
    amount: { gte: minAmount },  // è‡ªåŠ¨ç±»å‹è½¬æ¢
  },
});
```

#### ä¸å®‰å…¨ç¤ºä¾‹ï¼ˆé¡¹ç›®ä¸­æœªä½¿ç”¨ï¼‰

```javascript
// âŒ åŸå§‹ SQLï¼ˆå®¹æ˜“å— SQL æ³¨å…¥æ”»å‡»ï¼‰
const result = await db.$queryRaw`
  SELECT * FROM users WHERE id = ${userId}
`;

// âœ… å¦‚æœå¿…é¡»ä½¿ç”¨åŸå§‹ SQLï¼Œä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
const result = await db.$queryRaw`
  SELECT * FROM users WHERE id = ${Prisma.raw(userId)}
`;
```

---

### 5.3 XSS Protection | XSS é˜²æŠ¤

#### å¤šå±‚é˜²æŠ¤

**1. ArcJet Shield (Middleware)**:
```javascript
shield({
  mode: "LIVE",  // è‡ªåŠ¨æ£€æµ‹å’Œé˜»æ­¢ XSS payload
})
```

**2. React è‡ªåŠ¨è½¬ä¹‰**:
```jsx
// âœ… React è‡ªåŠ¨è½¬ä¹‰ç”¨æˆ·è¾“å…¥
<div>{transaction.description}</div>

// âœ… å®‰å…¨çš„ HTML
<div dangerouslySetInnerHTML={{ __html: sanitizedHTML }} />  // éœ€è¦æ‰‹åŠ¨æ¸…ç†
```

**3. å†…å®¹å®‰å…¨ç­–ç•¥ (CSP)**:

**æ¨èé…ç½®** (éœ€è¦æ·»åŠ åˆ° `next.config.mjs`):
```javascript
const securityHeaders = [
  {
    key: 'Content-Security-Policy',
    value: `
      default-src 'self';
      script-src 'self' 'unsafe-eval' 'unsafe-inline' https://clerk.*.com;
      style-src 'self' 'unsafe-inline';
      img-src 'self' data: https:;
      font-src 'self' data:;
      connect-src 'self' https://*.clerk.com https://api.resend.com;
    `.replace(/\s{2,}/g, ' ').trim()
  }
];
```

---

### 5.4 Data Access Control | æ•°æ®è®¿é—®æ§åˆ¶

#### Row-Level Security (åº”ç”¨å±‚)

**å®ç°æ¨¡å¼**: æ‰€æœ‰æŸ¥è¯¢éƒ½éªŒè¯ç”¨æˆ·æ‰€æœ‰æƒ

```javascript
// actions/account.js:28-32
const account = await db.account.findUnique({
  where: {
    id: accountId,
    userId: user.id,  // âœ… ç¡®ä¿ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„è´¦æˆ·
  },
});
```

#### è®¿é—®æ§åˆ¶çŸ©é˜µ

| èµ„æº | ç”¨æˆ· A | ç”¨æˆ· B | éªŒè¯æ–¹å¼ |
|------|-------|-------|---------|
| è´¦æˆ· A.1 | âœ… è¯»å†™ | âŒ æ— æƒé™ | `userId` åŒ¹é… |
| äº¤æ˜“ A.1 | âœ… è¯»å†™ | âŒ æ— æƒé™ | `userId` åŒ¹é… |
| é¢„ç®— A | âœ… è¯»å†™ | âŒ æ— æƒé™ | `userId` åŒ¹é… |
| è´¦æˆ· B.1 | âŒ æ— æƒé™ | âœ… è¯»å†™ | `userId` åŒ¹é… |

#### æ•°æ®éš”ç¦»æ£€æŸ¥æ¸…å•

- âœ… æ‰€æœ‰ `findUnique` åŒ…å« `userId`
- âœ… æ‰€æœ‰ `findMany` åŒ…å« `where: { userId }`
- âœ… æ‰€æœ‰ `update` åŒ…å« `where: { id, userId }`
- âœ… æ‰€æœ‰ `delete` åŒ…å« `where: { id, userId }`

---

### 5.5 HTTPS/TLS Enforcement | HTTPS å¼ºåˆ¶

**ç”Ÿäº§ç¯å¢ƒé…ç½®**:

```javascript
// middleware.js (å¯ä»¥æ·»åŠ )
export function middleware(req) {
  // å¼ºåˆ¶ HTTPS
  if (process.env.NODE_ENV === 'production' && !req.headers.get('x-forwarded-proto')?.includes('https')) {
    return NextResponse.redirect(`https://${req.headers.get('host')}${req.nextUrl.pathname}`, 301);
  }
}
```

**Vercel è‡ªåŠ¨é…ç½®**:
- âœ… è‡ªåŠ¨ HTTPS é‡å®šå‘
- âœ… å…è´¹ SSL è¯ä¹¦
- âœ… HTTP/2 æ”¯æŒ

---

## 6. Security Architecture Overview | å®‰å…¨æ¶æ„æ¦‚è§ˆ

### 6.1 å®Œæ•´å®‰å…¨æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         User Request                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  1. HTTPS/TLS Layer     â”‚
                  â”‚     (Transport Security)â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  2. ArcJet Shield       â”‚
                  â”‚     - SQL Injection     â”‚
                  â”‚     - XSS Prevention    â”‚
                  â”‚     - Path Traversal    â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  3. Bot Detection       â”‚
                  â”‚     - Allow Search Bots â”‚
                  â”‚     - Block Malicious   â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  4. Clerk Authenticationâ”‚
                  â”‚     - Session Validationâ”‚
                  â”‚     - User Identification
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  5. Route Protection    â”‚
                  â”‚     - Public/Protected  â”‚
                  â”‚     - Redirect if neededâ”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  6. Server Action       â”‚
                  â”‚     - Re-verify Auth    â”‚
                  â”‚     - Rate Limit Check  â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  7. Input Validation    â”‚
                  â”‚     - Zod Schema (Frontend)
                  â”‚     - Type Checking     â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  8. Ownership Verification
                  â”‚     - userId Match      â”‚
                  â”‚     - Row-Level Securityâ”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  9. Database Query      â”‚
                  â”‚     - Prisma ORM        â”‚
                  â”‚     - Parameterized     â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  10. Response           â”‚
                  â”‚     - Data Serializationâ”‚
                  â”‚     - React XSS Protection
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 6.2 Defense in Depth | æ·±åº¦é˜²å¾¡

| å±‚çº§ | é˜²æŠ¤æªæ–½ | å·¥å…·/æŠ€æœ¯ |
|------|---------|----------|
| **ç½‘ç»œå±‚** | HTTPS/TLS | Vercel |
| **åº”ç”¨å±‚** | WAF (Webåº”ç”¨é˜²ç«å¢™) | ArcJet Shield |
| **è®¤è¯å±‚** | OAuth 2.0, JWT | Clerk |
| **æˆæƒå±‚** | Row-Level Security | åº”ç”¨é€»è¾‘ |
| **è¾“å…¥å±‚** | Schema Validation | Zod |
| **æ•°æ®å±‚** | Parameterized Queries | Prisma ORM |
| **è¾“å‡ºå±‚** | Auto-Escaping | React |
| **ç›‘æ§å±‚** | Rate Limiting | ArcJet Token Bucket |

---

## 7. Security Best Practices | å®‰å…¨æœ€ä½³å®è·µ

### 7.1 Current Implementation Strengths | å½“å‰å®ç°ä¼˜åŠ¿

âœ… **å¤šå±‚è®¤è¯**:
- Middleware å±‚è®¤è¯
- Server Actions å±‚å†æ¬¡éªŒè¯
- æ•°æ®åº“æŸ¥è¯¢å±‚æ‰€æœ‰æƒæ£€æŸ¥

âœ… **è‡ªåŠ¨åŒ–å®‰å…¨**:
- Prisma è‡ªåŠ¨ SQL æ³¨å…¥é˜²æŠ¤
- React è‡ªåŠ¨ XSS è½¬ä¹‰
- ArcJet è‡ªåŠ¨å¨èƒæ£€æµ‹

âœ… **é€Ÿç‡é™åˆ¶**:
- é˜²æ­¢æš´åŠ›ç ´è§£
- é˜²æ­¢æ»¥ç”¨ API
- ä¿æŠ¤å¤–éƒ¨æœåŠ¡é…é¢

âœ… **Bot é˜²æŠ¤**:
- é˜»æ­¢æ¶æ„çˆ¬è™«
- å…è®¸åˆæ³•æœç´¢å¼•æ“
- ä¿æŠ¤ webhook ç«¯ç‚¹

---

### 7.2 Recommended Improvements | å»ºè®®æ”¹è¿›

#### 1. æ·»åŠ  Server Actions è¾“å…¥éªŒè¯

**å½“å‰**:
```javascript
// âŒ ä»…åœ¨å‰ç«¯éªŒè¯
export async function createAccount(data) {
  // ç›´æ¥ä½¿ç”¨ dataï¼Œæ²¡æœ‰æœåŠ¡ç«¯éªŒè¯
}
```

**å»ºè®®**:
```javascript
// âœ… æ·»åŠ æœåŠ¡ç«¯éªŒè¯
export async function createAccount(data) {
  // éªŒè¯è¾“å…¥
  const validatedData = accountSchema.parse(data);

  // ... rest of logic
}
```

---

#### 2. å®æ–½ CSRF ä¿æŠ¤

**Next.js 15 Server Actions**:
- å†…ç½® CSRF ä¿æŠ¤ï¼ˆé€šè¿‡ Origin å’Œ Host å¤´æ£€æŸ¥ï¼‰
- å»ºè®®ï¼šæ·»åŠ è‡ªå®šä¹‰ CSRF token ç”¨äºè¡¨å•

**å®ç°ç¤ºä¾‹**:
```javascript
// lib/csrf.js
import { cookies } from 'next/headers';

export function generateCsrfToken() {
  const token = crypto.randomUUID();
  cookies().set('csrf-token', token, { httpOnly: true, sameSite: 'strict' });
  return token;
}

export function verifyCsrfToken(token) {
  const cookieToken = cookies().get('csrf-token')?.value;
  return token === cookieToken;
}
```

---

#### 3. æ·»åŠ å®¡è®¡æ—¥å¿—

**è®°å½•å…³é”®æ“ä½œ**:
```javascript
// lib/audit.js
export async function auditLog(action, userId, details) {
  await db.auditLog.create({
    data: {
      action,
      userId,
      details: JSON.stringify(details),
      timestamp: new Date(),
      ipAddress: req.headers.get('x-forwarded-for'),
    },
  });
}

// ä½¿ç”¨ç¤ºä¾‹
await auditLog('account.created', user.id, { accountId: account.id });
await auditLog('transaction.deleted', user.id, { transactionId: id });
```

---

#### 4. å®æ–½ API å¯†é’¥è½®æ¢

**è‡ªåŠ¨åŒ–å¯†é’¥è½®æ¢**:
```bash
# ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†æœåŠ¡
# AWS Secrets Manager, HashiCorp Vault ç­‰

# å®šæœŸè½®æ¢å¯†é’¥çš„è„šæœ¬
npm run rotate-keys
```

---

#### 5. æ·»åŠ å®‰å…¨å“åº”å¤´

**next.config.mjs**:
```javascript
const securityHeaders = [
  {
    key: 'X-DNS-Prefetch-Control',
    value: 'on'
  },
  {
    key: 'Strict-Transport-Security',
    value: 'max-age=63072000; includeSubDomains; preload'
  },
  {
    key: 'X-Frame-Options',
    value: 'SAMEORIGIN'
  },
  {
    key: 'X-Content-Type-Options',
    value: 'nosniff'
  },
  {
    key: 'X-XSS-Protection',
    value: '1; mode=block'
  },
  {
    key: 'Referrer-Policy',
    value: 'origin-when-cross-origin'
  },
  {
    key: 'Permissions-Policy',
    value: 'camera=(), microphone=(), geolocation=()'
  }
];

module.exports = {
  async headers() {
    return [
      {
        source: '/:path*',
        headers: securityHeaders,
      },
    ];
  },
};
```

---

#### 6. æ•°æ®åŠ å¯†

**æ•æ„Ÿå­—æ®µåŠ å¯†**:
```javascript
// lib/encryption.js
import crypto from 'crypto';

const algorithm = 'aes-256-gcm';
const key = Buffer.from(process.env.ENCRYPTION_KEY, 'hex');

export function encrypt(text) {
  const iv = crypto.randomBytes(16);
  const cipher = crypto.createCipheriv(algorithm, key, iv);
  let encrypted = cipher.update(text, 'utf8', 'hex');
  encrypted += cipher.final('hex');
  const authTag = cipher.getAuthTag();
  return `${iv.toString('hex')}:${authTag.toString('hex')}:${encrypted}`;
}

export function decrypt(text) {
  const [ivHex, authTagHex, encrypted] = text.split(':');
  const iv = Buffer.from(ivHex, 'hex');
  const authTag = Buffer.from(authTagHex, 'hex');
  const decipher = crypto.createDecipheriv(algorithm, key, iv);
  decipher.setAuthTag(authTag);
  let decrypted = decipher.update(encrypted, 'hex', 'utf8');
  decrypted += decipher.final('utf8');
  return decrypted;
}
```

---

### 7.3 Security Checklist | å®‰å…¨æ£€æŸ¥æ¸…å•

#### éƒ¨ç½²å‰æ£€æŸ¥

- [ ] æ‰€æœ‰ç¯å¢ƒå˜é‡å·²é…ç½®ä¸”ä¸åœ¨ç‰ˆæœ¬æ§åˆ¶ä¸­
- [ ] HTTPS å·²å¯ç”¨
- [ ] ArcJet è®¾ç½®ä¸º LIVE æ¨¡å¼
- [ ] Clerk ç”Ÿäº§å¯†é’¥å·²é…ç½®
- [ ] æ•°æ®åº“è¿æ¥ä½¿ç”¨ SSL
- [ ] é€Ÿç‡é™åˆ¶å·²å¯ç”¨
- [ ] Bot æ£€æµ‹å·²å¯ç”¨
- [ ] æ‰€æœ‰ API ç«¯ç‚¹éœ€è¦è®¤è¯
- [ ] `/api/seed` ç«¯ç‚¹å·²ç§»é™¤æˆ–ä¿æŠ¤
- [ ] å®¡è®¡æ—¥å¿—å·²å¯ç”¨
- [ ] é”™è¯¯æ¶ˆæ¯ä¸æ³„éœ²æ•æ„Ÿä¿¡æ¯
- [ ] ä¾èµ–åŒ…å·²æ›´æ–°ï¼ˆæ— å·²çŸ¥æ¼æ´ï¼‰

#### ä»£ç å®¡æŸ¥æ£€æŸ¥

- [ ] æ‰€æœ‰ Server Actions éªŒè¯ç”¨æˆ·è®¤è¯
- [ ] æ‰€æœ‰æ•°æ®åº“æŸ¥è¯¢åŒ…å«ç”¨æˆ·æ‰€æœ‰æƒæ£€æŸ¥
- [ ] ä½¿ç”¨ Zod schema éªŒè¯è¾“å…¥
- [ ] æ²¡æœ‰ä½¿ç”¨ `dangerouslySetInnerHTML`ï¼ˆæˆ–å·²æ¸…ç†ï¼‰
- [ ] æ²¡æœ‰åŸå§‹ SQL æŸ¥è¯¢ï¼ˆæˆ–å·²å‚æ•°åŒ–ï¼‰
- [ ] æ•æ„Ÿæ“ä½œæœ‰é€Ÿç‡é™åˆ¶
- [ ] æ–‡ä»¶ä¸Šä¼ æœ‰å¤§å°å’Œç±»å‹é™åˆ¶
- [ ] æ—¥å¿—ä¸åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç ã€tokenï¼‰

---

## Summary | æ€»ç»“

### Security Architecture Highlights | å®‰å…¨æ¶æ„äº®ç‚¹

1. **å¤šå±‚é˜²å¾¡ç­–ç•¥**:
   - ArcJet Shield (WAF)
   - Clerk Authentication
   - Prisma ORM (SQL æ³¨å…¥é˜²æŠ¤)
   - React (XSS é˜²æŠ¤)

2. **é€Ÿç‡é™åˆ¶ä¿æŠ¤**:
   - Token Bucket ç®—æ³•
   - æ¯ç”¨æˆ· 10 æ¬¡/å°æ—¶
   - è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

3. **æ™ºèƒ½ Bot ç®¡ç†**:
   - é˜»æ­¢æ¶æ„çˆ¬è™«
   - å…è®¸æœç´¢å¼•æ“
   - å…è®¸ webhook å®¢æˆ·ç«¯

4. **è¾“å…¥éªŒè¯**:
   - Zod schema å®šä¹‰
   - å‰ç«¯å®æ—¶éªŒè¯
   - ç±»å‹å®‰å…¨ä¿è¯

5. **æ•°æ®éš”ç¦»**:
   - æ‰€æœ‰æŸ¥è¯¢éªŒè¯æ‰€æœ‰æƒ
   - Row-Level Security
   - ç”¨æˆ·æ•°æ®å®Œå…¨éš”ç¦»

### Security Score | å®‰å…¨è¯„åˆ†

| å®‰å…¨ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|---------|------|------|
| **è®¤è¯** | 9/10 | Clerk æä¾›å¼ºå¤§çš„è®¤è¯ |
| **æˆæƒ** | 8/10 | åº”ç”¨å±‚å®ç°è‰¯å¥½ |
| **è¾“å…¥éªŒè¯** | 7/10 | å‰ç«¯å®Œå–„ï¼Œåç«¯å¯æ”¹è¿› |
| **SQL æ³¨å…¥** | 10/10 | Prisma å®Œå…¨é˜²æŠ¤ |
| **XSS** | 9/10 | React + Shield åŒé‡é˜²æŠ¤ |
| **CSRF** | 8/10 | Next.js å†…ç½®ï¼Œå¯åŠ å¼º |
| **é€Ÿç‡é™åˆ¶** | 9/10 | ArcJet å®ç°ä¼˜ç§€ |
| **æ•°æ®åŠ å¯†** | 6/10 | ä¼ è¾“åŠ å¯†ï¼Œå­˜å‚¨å¯æ”¹è¿› |
| **æ—¥å¿—å®¡è®¡** | 5/10 | éœ€è¦æ·»åŠ å®¡è®¡æ—¥å¿— |

**æ€»ä½“è¯„åˆ†**: **8.1/10** - å®‰å…¨æ€§è‰¯å¥½ï¼Œæœ‰æ”¹è¿›ç©ºé—´

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2025-11-15
**ç›¸å…³æ–‡æ¡£**:
- `00-project-overview.md`
- `01-database-analysis.md`
- `02-backend-analysis.md`
