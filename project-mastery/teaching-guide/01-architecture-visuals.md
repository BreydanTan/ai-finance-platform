# 架构可视化 - 用日常类比理解技术架构

**目标**: 用你熟悉的概念理解陌生的技术

---

## 1. 全局架构 - 餐厅类比

### 🍽️ 想象一家智能餐厅

```
┌──────────────────────────────────────────────────────────┐
│                    顾客（用户）                            │
│              用浏览器访问你的餐厅网站                       │
└────────────────────┬─────────────────────────────────────┘
                     │
                     ▼
            ┌─────────────────┐
            │   餐厅前台       │ ← components/header.jsx
            │  (导航栏)        │    components/hero.jsx
            │  - 欢迎标语      │
            │  - 菜单导航      │
            └────────┬────────┘
                     │
        ┌────────────┴────────────┐
        │                         │
        ▼                         ▼
┌───────────────┐         ┌───────────────┐
│   点餐区       │         │   查看账单     │
│ (创建交易)     │         │  (仪表板)      │
│               │         │               │
│ app/          │         │ app/          │
│ transaction/  │         │ dashboard/    │
│ create/       │         │ page.jsx      │
└───────┬───────┘         └───────┬───────┘
        │                         │
        └────────────┬────────────┘
                     │
                     ▼
            ┌─────────────────┐
            │   服务员         │ ← actions/*.js
            │  (Server Actions)│    (传递信息的中间人)
            │  - 接收订单      │
            │  - 检查库存      │
            │  - 送餐          │
            └────────┬────────┘
                     │
                     ▼
            ┌─────────────────┐
            │   厨房           │ ← Prisma + PostgreSQL
            │  (数据库)        │    (处理和存储数据)
            │  - 准备食物      │
            │  - 管理库存      │
            │  - 记录订单      │
            └─────────────────┘
```

### 对应关系

| 餐厅部分 | 技术部分 | 代码位置 |
|---------|---------|---------|
| 顾客 | 用户浏览器 | - |
| 前台 | React 组件 | `components/` |
| 菜单 | 页面 | `app/(main)/` |
| 服务员 | Server Actions | `actions/` |
| 厨房 | 数据库 + Prisma | `prisma/` |
| 后厨经理 | 中间件 | `middleware.js` |
| 财务系统 | Clerk 认证 | 外部服务 |

---

## 2. 数据流动 - 外卖订单类比

### 📱 美团外卖下单流程

```
1. 你打开美团 App
   ↓
   [类比：用户打开网站]

2. 浏览菜单，选择菜品
   ↓
   [类比：浏览交易表单，填写信息]

3. 点击"提交订单"
   ↓
   [类比：点击表单的"创建"按钮]

4. 订单发送到餐厅
   ↓
   [类比：数据发送到 Server Action]

5. 餐厅确认订单，扣减库存
   ↓
   [类比：数据库创建 Transaction，更新 Account 余额]

6. 骑手接单配送
   ↓
   [类比：后台作业处理（Inngest）]

7. 你收到"订单完成"通知
   ↓
   [类比：页面显示成功提示，数据刷新]
```

### 代码对应

| 步骤 | 代码文件 |
|-----|---------|
| 打开页面 | `app/(main)/transaction/create/page.jsx` |
| 填写表单 | `_components/transaction-form.jsx` |
| 提交数据 | `handleSubmit()` → `createTransactionFn()` |
| 服务器处理 | `actions/transaction.js:createTransaction()` |
| 数据库操作 | `await db.transaction.create({ ... })` |
| 更新余额 | `await db.account.update({ ... })` |
| 返回结果 | `return { success: true, data: ... }` |
| 页面刷新 | `revalidatePath("/dashboard")` |

---

## 3. 文件组织 - 图书馆类比

### 📚 想象一个智能图书馆

```
ai-finance-platform/  (整个图书馆)
│
├── app/              (主阅览区 - 所有书架)
│   ├── (auth)/       (会员办理区 - 登录注册)
│   │   ├── sign-in/
│   │   └── sign-up/
│   │
│   ├── (main)/       (主要阅读区)
│   │   ├── dashboard/     (总览台)
│   │   ├── transaction/   (交易记录区)
│   │   └── account/       (账户管理区)
│   │
│   └── api/          (信息服务台 - 特殊查询)
│
├── components/       (可复用的书籍部分)
│   ├── ui/          (基础组件 - 标准章节模板)
│   └── *.jsx        (特定组件 - 专题文章)
│
├── actions/          (图书管理员办公室 - 后台操作)
│   ├── dashboard.js  (总台管理员)
│   ├── transaction.js (交易记录员)
│   └── budget.js     (预算专员)
│
├── prisma/           (图书馆档案室 - 数据库设计)
│   ├── schema.prisma (档案分类系统)
│   └── migrations/   (历史变更记录)
│
├── lib/              (工具书区 - 辅助函数)
│   └── utils.js     (常用工具)
│
└── data/             (参考资料 - 静态数据)
    └── categories.js (分类目录)
```

### 查找指南

**需求**: 我想修改登录页面的样式

**查找路径**:
1. 登录页面 → `(auth)` 阅览区
2. 进入 `sign-in` 文件夹
3. 找到 `page.jsx` (Clerk 提供，无需修改)
4. 如果想修改布局 → `(auth)/layout.js`

---

**需求**: 我想改变"创建交易"的逻辑

**查找路径**:
1. 后台操作 → `actions/` 管理员办公室
2. 交易相关 → `transaction.js`
3. 找到 `createTransaction` 函数

---

## 4. 技术栈层次 - 蛋糕类比

### 🎂 五层生日蛋糕

```
        ┌──────────────────┐
        │   装饰层          │ ← Tailwind CSS (样式)
        │  (奶油和水果)     │    让蛋糕好看
        └──────────────────┘
                ↓
        ┌──────────────────┐
        │   顶层           │ ← React Components (UI)
        │  (奶油蛋糕)      │    用户看到的界面
        └──────────────────┘
                ↓
        ┌──────────────────┐
        │   中间层          │ ← Next.js (框架)
        │  (蛋糕主体)      │    组织和路由
        └──────────────────┘
                ↓
        ┌──────────────────┐
        │   底层           │ ← Node.js (运行时)
        │  (蛋糕底座)      │    执行 JavaScript
        └──────────────────┘
                ↓
        ┌──────────────────┐
        │   最底层          │ ← PostgreSQL (数据库)
        │  (蛋糕托盘)      │    存储所有数据
        └──────────────────┘
```

**吃蛋糕的过程**（用户操作）:
1. 看到漂亮的装饰 → CSS 样式
2. 品尝奶油层 → React 组件交互
3. 享受蛋糕主体 → Next.js 处理请求
4. 底座支撑稳固 → Node.js 运行代码
5. 托盘承载一切 → 数据库存储数据

---

## 5. 组件层次 - 乐高积木类比

### 🧱 组件就像乐高积木

**基础积木** (`components/ui/`):
```
┌─────┐  ┌─────┐  ┌─────┐  ┌─────┐
│Button│  │Input│  │Card │  │Table│
└─────┘  └─────┘  └─────┘  └─────┘
```
- 最小单元，可重复使用
- 标准化规格

**组合积木** (`components/`):
```
┌────────────────────────────┐
│   CreateAccountDrawer       │
│  ┌──────┐  ┌──────┐        │
│  │Input │  │Button│        │
│  └──────┘  └──────┘        │
└────────────────────────────┘
```
- 由基础积木组成
- 实现特定功能

**完整作品** (`app/(main)/dashboard/page.jsx`):
```
┌──────────────────────────────────────┐
│         Dashboard Page                │
│  ┌────────────────┐  ┌─────────────┐ │
│  │ BudgetProgress │  │ AccountCard │ │
│  │  ┌───┐  ┌───┐ │  │  ┌───┐ ┌──┐ │ │
│  │  │Bar│  │Text│ │  │  │Img│ │$$│ │ │
│  │  └───┘  └───┘ │  │  └───┘ └──┘ │ │
│  └────────────────┘  └─────────────┘ │
└──────────────────────────────────────┘
```
- 完整页面
- 由多个组件组成

**搭建过程**:
1. 选择基础积木 → `import { Button } from "@/components/ui/button"`
2. 组合成新积木 → 创建 `MyCustomComponent`
3. 搭建完整作品 → 页面集成所有组件

---

## 6. 状态管理 - 快递包裹追踪类比

### 📦 状态就像包裹的当前位置

**本地状态** (`useState`):
```
你的包裹在你手中
- 只有你能看到
- 只在你这里有效
- 不会影响别人

代码例子：
const [isOpen, setIsOpen] = useState(false);
// 抽屉是否打开 - 只在这个组件有效
```

**服务器状态** (Server Components):
```
包裹在快递中心
- 所有人查询同一个系统
- 数据来自中央服务器
- 最新最准确的信息

代码例子：
const accounts = await getUserAccounts();
// 从数据库获取账户列表 - 所有用户都访问同一数据源
```

**URL 状态** (路由参数):
```
包裹追踪号
- 分享给别人也能看到
- 刷新页面不丢失
- 可以收藏和分享

代码例子：
/account/abc123  // abc123 就是账户 ID
```

---

## 7. 数据获取模式 - 点外卖类比

### 🛵 两种获取数据的方式

**方式 1: 服务器组件（堂食）**
```
你去餐厅 → 厨房做好菜 → 服务员端给你
         ↓
页面加载 → 服务器查数据库 → 直接渲染 HTML

优点：
- 菜端上来就是热的（数据已经准备好）
- 你不用等（无需客户端加载）
- SEO 友好（搜索引擎能看到内容）

代码示例：
// app/(main)/dashboard/page.jsx
export default async function DashboardPage() {
  const accounts = await getUserAccounts();  // 服务器端获取
  return <div>{accounts.map(...)}</div>;     // 直接渲染
}
```

**方式 2: 客户端组件（外卖）**
```
你在家点餐 → 骑手配送 → 你收到外卖
         ↓
页面打开 → 发起请求 → 显示加载中 → 数据到达 → 显示内容

优点：
- 不用出门（页面可以先显示）
- 交互性强（可以动态更新）
- 用户操作触发（按需加载）

代码示例：
// 客户端组件
const { fn, loading } = useFetch(createAccount);

return (
  <button onClick={() => fn(data)} disabled={loading}>
    {loading ? "创建中..." : "创建账户"}
  </button>
);
```

---

## 8. 认证流程 - 门禁系统类比

### 🔐 像小区门禁一样的认证

```
1. 你走到小区门口
   ↓
   [访问受保护页面，如 /dashboard]

2. 门禁刷卡识别
   ↓
   [Middleware 检查 Clerk session]

3. 验证身份
   ├─ 有效门卡 → 开门放行
   │  [有 session → 允许访问]
   │
   └─ 无效/没卡 → 引导去门卫室登记
      [无 session → 重定向到 /sign-in]

4. 登记成功后发放门卡
   ↓
   [Clerk 创建 session]

5. 以后进出畅通无阻
   ↓
   [后续访问自动通过]
```

**代码对应**:

| 步骤 | 代码位置 |
|-----|---------|
| 门口 | 任何受保护的路由 |
| 门禁 | `middleware.js:32-44` |
| 门卫室 | Clerk 登录页 |
| 门卡 | Session token |
| 开门 | `NextResponse.next()` |
| 引导登记 | `redirectToSignIn()` |

---

## 9. 表单验证 - 填写快递单类比

### 📝 表单验证像快递单审核

```
1. 你填写快递单
   ↓
   [用户填写表单字段]

2. 工作人员检查
   ├─ 收件人姓名: ✅ 已填写
   ├─ 电话号码: ❌ 格式错误 (需要 11 位)
   └─ 地址: ✅ 已填写
   ↓
   [Zod schema 实时验证]

3. 你修正错误
   ↓
   [用户看到错误提示并修改]

4. 再次检查: 全部通过
   ↓
   [所有字段验证通过]

5. 接受快递单，开始配送
   ↓
   [调用 Server Action 提交数据]
```

**Zod 验证规则就像快递公司的要求**:

```javascript
const transactionSchema = z.object({
  amount: z.string().min(1),        // 必须填金额
  date: z.date(),                    // 必须选日期
  accountId: z.string().min(1),      // 必须选账户
});

// 就像快递单要求：
// - 收件人不能为空
// - 电话必须是数字
// - 地址必须详细
```

---

## 10. 项目运行流程 - 开商店类比

### 🏪 从开店到营业

**开发环境（试营业）**:
```
1. 装修店铺
   npm install           # 采购设备（安装依赖）

2. 培训员工
   npx prisma generate   # 生成 Prisma 客户端（准备工具）

3. 布置商品
   npx prisma migrate deploy  # 运行数据库迁移（设置货架）

4. 试营业
   npm run dev           # 启动开发服务器（开门迎客）
```

**生产环境（正式营业）**:
```
1. 装修完工
   npm run build         # 生产构建（准备好所有东西）

2. 正式开业
   npm start             # 启动生产服务器（正式营业）

3. 部署到商场
   vercel --prod         # 部署到 Vercel（入驻大商场）
```

---

## 总结：用你已知的理解未知的

| 技术概念 | 日常类比 |
|---------|---------|
| 前端 | 餐厅前台 |
| 后端 | 餐厅厨房 |
| 数据库 | 仓库 |
| API | 服务员 |
| 组件 | 乐高积木 |
| 状态 | 包裹位置 |
| 认证 | 门禁系统 |
| 表单验证 | 快递单审核 |
| Server Actions | 外卖骑手 |
| 中间件 | 保安检查 |

---

## 下一步

现在你已经理解了整体架构，接下来：

1. **查看概念词典** → `02-concept-dictionary.md`
   - 学习具体技术术语的含义

2. **开始实践** → `03-stage1-foundation.md`
   - 动手搭建环境，看到真实效果

记住：**不懂的时候，想想日常生活中的类似场景！**

---

**文档版本**: 1.0
**最后更新**: 2025-11-16
